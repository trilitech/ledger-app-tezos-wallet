.sync_docker_template:
  services:
    - docker:20.10.16-dind
  variables:
    BUILD_VOLUME: VOL_$CI_JOB_ID
    IMAGE: ""
    DOCKERFILE: ""
    DEFAULT: $CI_REGISTRY_IMAGE/$IMAGE:$CI_DEFAULT_BRANCH
    SOURCE: $CI_REGISTRY_IMAGE/$IMAGE:$CI_COMMIT_REF_SLUG
  image: docker:20.10.16
  stage: sync
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - export TARGET_REF_SLUG=$(eval echo $CI_MERGE_REQUEST_TARGET_BRANCH_NAME | cut -c -63 | sed -E 's/[^a-z0-9-]+/-/g' | sed -E 's/^-*([a-z0-9-]+[a-z0-9])-*$$/\1/g')
    - export TARGET=$CI_REGISTRY_IMAGE/$IMAGE:$TARGET_REF_SLUG
    - eval "$BEFORE_SCRIPT"
  script:
    - docker pull $SOURCE ||
      docker pull $TARGET ||
      docker pull $DEFAULT ||
      true
    - docker build --cache-from $SOURCE
                   --cache-from $TARGET
                   --cache-from $DEFAULT
                   --tag $SOURCE
                   -f $DOCKERFILE
                   .
    - if docker manifest inspect $SOURCE; then
        docker push $SOURCE;
      else
        docker manifest create $SOURCE $SOURCE;
      fi
  rules:
    - if: $CI_MERGE_REQUEST_IID || $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

sync docker ledger-app-builder:
  extends: .sync_docker_template
  variables:
    BEFORE_SCRIPT: |
      apk add --update git
      git clone https://github.com/LedgerHQ/ledger-app-builder.git TMP
      cd TMP/full &&
      git checkout 79a7c077b6c0223dca614ef391e8df93ef2ca40e
    IMAGE: ledger-app-builder
    DOCKERFILE: Dockerfile

sync docker ledger-app-tezos-ocaml:
  extends: .sync_docker_template
  variables:
    BEFORE_SCRIPT: cd docker
    IMAGE: ledger-app-tezos-ocaml
    DOCKERFILE: Dockerfile.ocaml

sync docker ledger-app-tezos-integration-tests:
  extends: .sync_docker_template
  variables:
    BEFORE_SCRIPT: cd docker
    IMAGE: ledger-app-tezos-integration-tests
    DOCKERFILE: Dockerfile.integration-tests
